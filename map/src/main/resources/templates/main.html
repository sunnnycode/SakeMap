<!DOCTYPE html>
<html>
<head>
    <title>일본 사케 지도</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkAAj6kvP-nK9QK8-SmP-sKIOiL49R0Jo&libraries=places"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
        }
         #side-panel {
        position: fixed;
        top: 0;
        left: -400px; /* 기본적으로 화면 밖에 위치 */
        right: auto; /* 오른쪽 고정 해제 */
        width: 400px;
        height: 100%;
        background-color: white;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2); /* 그림자 방향 변경 */
        z-index: 1000;
        transition: left 0.3s ease; /* 슬라이드 애니메이션 */
        overflow-y: auto;
        padding: 15px;
    }
    #side-panel.open {
        left: 0; /* 열렸을 때 화면 안으로 들어옴 */
    }
        #side-panel h3 {
            margin-top: 0;
        }
        #close-panel-btn {
            background-color: #ff6666;
            border: none;
            color: white;
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            border-radius: 5px;
        }
        #product-tab {
            display: none;
        }
        #menu-btn {
            margin-top: 10px;
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        #menu-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body onload="initMap()">
<div id="map"></div>
<div id="side-panel">
    <button id="close-panel-btn" onclick="closePanel()">닫기</button>
    <div id="place-info">
        <h3 id="place-name"></h3>
        <p><strong>주소:</strong> <span id="place-address"></span></p>
        <p><strong>전화:</strong> <span id="place-phone"></span></p>
        <p><strong>웹사이트:</strong> <a id="place-website" href="#" target="_blank">열기</a></p>
        <div id="place-photo"></div>
    </div>
    <button id="menu-btn" onclick="toggleProductTab()">메뉴</button>
    <div id="product-tab">
        <h3>상품 목록</h3>
        <ul id="product-list"></ul>
    </div>
</div>
<script>
    let currentOpenMarker = null; // 현재 열려 있는 마커 추적

    function initMap() {
        const map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 35.6762, lng: 139.6503 }, // 도쿄의 위도와 경도
            zoom: 12
        });

        fetch('http://localhost:8080/open-api/store/') // 가게 목록 API 호출
            .then(response => response.json())
            .then(stores => {
                stores.forEach(store => {
                    const placeCode = store.placeCode;

                    // 구글 Place API로 장소 정보 가져오기
                    const service = new google.maps.places.PlacesService(map);
                    service.getDetails({ placeId: placeCode }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            const marker = new google.maps.Marker({
                                position: place.geometry.location,
                                map: map,
                                title: place.name
                            });

                            google.maps.event.addListener(marker, 'click', function () {
                                // 다른 마커 클릭 시 패널 닫기
                                if (currentOpenMarker && currentOpenMarker !== marker) {
                                    closePanel();
                                }
                                currentOpenMarker = marker;

                                // 패널 열기
                                openPanel(place, store.id);
                            });
                        }
                    });
                });
            });
    }

    function openPanel(place, storeId) {
        document.getElementById('place-name').textContent = place.name || '이름 없음';
        document.getElementById('place-address').textContent = place.formatted_address || '주소 없음';
        document.getElementById('place-phone').textContent = place.formatted_phone_number || '전화번호 없음';
        document.getElementById('place-website').href = place.website || '#';
        document.getElementById('place-website').textContent = place.website ? '열기' : '없음';

        const photoContainer = document.getElementById('place-photo');
        photoContainer.innerHTML = ''; // 기존 사진 제거
        if (place.photos && place.photos.length > 0) {
            const photoUrl = place.photos[0].getUrl({ maxWidth: 400 });
            const img = document.createElement('img');
            img.src = photoUrl;
            img.style.width = '100%';
            photoContainer.appendChild(img);
        } else {
            photoContainer.textContent = '사진 없음';
        }

        document.getElementById('side-panel').classList.add('open');
        document.getElementById('product-tab').style.display = 'none'; // 상품 탭 닫기

        // 상품 데이터 로딩 준비
        document.getElementById('menu-btn').onclick = () => loadProductTab(storeId);
    }

   function closePanel() {
        document.getElementById('side-panel').classList.remove('open');
        currentOpenMarker = null; // 열려 있는 마커 초기화
    }

    function toggleProductTab() {
        const productTab = document.getElementById('product-tab');
        productTab.style.display = productTab.style.display === 'none' ? 'block' : 'none';
    }

    function loadProductTab(storeId) {
        fetch(`http://localhost:8080/open-api/product/storeId/${storeId}`)
            .then(response => response.json())
            .then(products => {
                const productList = document.getElementById('product-list');
                productList.innerHTML = ''; // 기존 상품 목록 제거

                products.forEach(product => {
                    const productItem = document.createElement('li');
                    productItem.innerHTML = `
                        <div>
                            <strong>${product.name}</strong><br>
                            가격: ${product.price}원<br>
                            카테고리: ${product.productCategory}<br>
                            <p>${product.content}</p>
                            ${product.thumbnailUrl ? `<img src="${product.thumbnailUrl}" alt="${product.name}" style="width:100px;">` : '<p>썸네일 이미지 없음</p>'}
                        </div>
                    `;
                    productList.appendChild(productItem);
                });

                toggleProductTab(); // 상품 탭 열기
            });
    }
</script>
</body>
</html>
